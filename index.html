<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<title>GÃ¼vercin PazarÄ± TR</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body{margin:0;font-family:Arial;background:#0f172a;color:#fff}
header{background:#020617;padding:15px;display:flex;justify-content:space-between}
h1{margin:0;color:#facc15;font-size:20px}
button{background:#facc15;border:none;padding:8px 12px;font-weight:bold;border-radius:4px;cursor:pointer}
input,select,textarea{width:100%;padding:7px;margin-bottom:6px}
.container{max-width:1000px;margin:auto;padding:15px}
.card{background:#020617;padding:12px;border-radius:8px;margin-bottom:12px}
.hidden{display:none}
img{width:100%;border-radius:6px}
.image-box{position:relative}
.owner{position:absolute;top:6px;left:6px;background:rgba(0,0,0,.7);color:#facc15;padding:4px 7px;border-radius:6px;font-size:12px;cursor:pointer}
.filter{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:6px}
.danger{background:#dc2626;color:#fff}
</style>
</head>
<body>

<header>
<h1>ğŸ•Šï¸ GÃ¼vercin PazarÄ± TR</h1>
<div id="nav"></div>
</header>

<div class="container">
<div id="auth"></div>
<div id="home"></div>
<div id="profile" class="hidden"></div>
<div id="chat" class="hidden"></div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, query, where, orderBy } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBxNAZRJZiXDirJDAlm5dLtk0Tp3V-Ncck",
  authDomain: "guvercin-pazari-tr.firebaseapp.com",
  projectId: "guvercin-pazari-tr",
  storageBucket: "guvercin-pazari-tr.firebasestorage.app",
  messagingSenderId: "1052845557831",
  appId: "1:1052845557831:web:6c2ee375cd692f8f694962"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth();
const db = getFirestore();

let user=null;

const nav=document.getElementById("nav");
const home=document.getElementById("home");
const authBox=document.getElementById("auth");
const profile=document.getElementById("profile");
const chat=document.getElementById("chat");

onAuthStateChanged(auth,u=>{
  user=u;
  renderNav();
  renderHome();
});

function renderNav(){
  nav.innerHTML = user ?
  `<button onclick="logout()">Ã‡Ä±kÄ±ÅŸ</button>` :
  `<button onclick="showLogin()">GiriÅŸ</button>
   <button onclick="showRegister()">Ãœye Ol</button>`;
}

window.logout=()=>auth.signOut();

window.showLogin=()=>{
authBox.innerHTML=`
<div class="card">
<h3>GiriÅŸ</h3>
<input id="le" placeholder="Email">
<input id="lp" type="password" placeholder="Åifre">
<button onclick="login()">GiriÅŸ</button>
</div>`;
}

window.showRegister=()=>{
authBox.innerHTML=`
<div class="card">
<h3>Ãœye Ol</h3>
<input id="re" placeholder="Email">
<input id="rp" type="password" placeholder="Åifre">
<button onclick="register()">Ãœye Ol</button>
</div>`;
}

window.login=()=>signInWithEmailAndPassword(auth,le.value,lp.value);
window.register=()=>createUserWithEmailAndPassword(auth,re.value,rp.value);

function renderHome(){
profile.classList.add("hidden");
chat.classList.add("hidden");
home.classList.remove("hidden");

home.innerHTML = user ? `
<div class="card">
<h3>Ä°lan Ekle</h3>
<input id="name" placeholder="Ä°lan baÅŸlÄ±ÄŸÄ±">
<select id="irk">
<option>Saya</option><option>DolapÃ§Ä±</option><option>TaklacÄ±</option>
<option>Kelebek</option><option>Posta</option>
</select>
<select id="cinsiyet"><option>Erkek</option><option>DiÅŸi</option></select>
<input id="yas" type="number" placeholder="YaÅŸ">
<select id="pedigree">
<option>Yok</option><option>Var</option>
</select>
<select id="asi">
<option>AÅŸÄ±sÄ±z</option><option>AÅŸÄ±lÄ±</option>
</select>
<input id="price" type="number" placeholder="BaÅŸlangÄ±Ã§ â‚º">
<input id="photo" type="file">
<button onclick="addAuction()">BaÅŸlat</button>
</div>`:"";

home.innerHTML+=`
<div class="card filter">
<select id="fIrk"><option value="">Irk</option><option>Saya</option><option>DolapÃ§Ä±</option><option>TaklacÄ±</option><option>Kelebek</option><option>Posta</option></select>
<select id="fC"><option value="">Cinsiyet</option><option>Erkek</option><option>DiÅŸi</option></select>
<select id="fA"><option value="">AÅŸÄ±</option><option>AÅŸÄ±lÄ±</option><option>AÅŸÄ±sÄ±z</option></select>
<button onclick="renderList()">Filtrele</button>
</div>
<div id="list"></div>`;

renderList();
}

window.addAuction=()=>{
const r=new FileReader();
r.onload=e=>{
addDoc(collection(db,"auctions"),{
name:name.value,irk:irk.value,cinsiyet:cinsiyet.value,
yas:Number(yas.value),pedigree:pedigree.value,asi:asi.value,
price:Number(price.value),photo:e.target.result,
owner:user.email,start:Date.now(),bids:[]
});
};
r.readAsDataURL(photo.files[0]);
}

function renderList(){
const list=document.getElementById("list");
list.innerHTML="";
onSnapshot(collection(db,"auctions"),snap=>{
list.innerHTML="";
snap.forEach(d=>{
const a=d.data();
if(fIrk.value && a.irk!==fIrk.value)return;
if(fC.value && a.cinsiyet!==fC.value)return;
if(fA.value && a.asi!==fA.value)return;

const last=a.bids[a.bids.length-1];
const ended=Date.now()>a.start+86400000;
const win=ended && last?.user===user?.email;

list.innerHTML+=`
<div class="card">
<div class="image-box">
<span class="owner" onclick="showProfile('${a.owner}')">@${a.owner}</span>
<img src="${a.photo}">
</div>
<b>${a.name}</b>
<p>${a.irk} â€¢ ${a.cinsiyet} â€¢ ${a.yas} yaÅŸ</p>
<p>${a.asi} ${a.irk==="Posta"?"â€¢ Pedigree: "+a.pedigree:""}</p>
<p>ğŸ’° ${a.price} â‚º</p>
<p>Son teklif: ${last?last.user:"Yok"}</p>
${!ended && user && user.email!==a.owner?`<button onclick='bid("${d.id}",${JSON.stringify(a.bids)},${a.price})'>Teklif</button>`:""}
${user?.email===a.owner?`<button class="danger" onclick="del('${d.id}')">Sil</button>`:""}
${win?`<button onclick='openChat("${d.id}", "${a.owner}")'>ğŸ’¬ MesajlaÅŸ</button>`:""}
</div>`;
});
});
}

window.bid=(id,bids,price)=>{
const v=prompt("Teklif â‚º");
if(Number(v)<=price)return alert("Daha yÃ¼ksek olmalÄ±");
updateDoc(doc(db,"auctions",id),{
price:Number(v),
bids:[...bids,{user:user.email,amount:Number(v)}]
});
}

window.del=id=>deleteDoc(doc(db,"auctions",id));

window.showProfile=email=>{
home.classList.add("hidden");
profile.classList.remove("hidden");
profile.innerHTML=`<div class="card"><h2>${email}</h2></div>`;
}

window.openChat=(aid,owner)=>{
home.classList.add("hidden");
chat.classList.remove("hidden");
const q=query(collection(db,"messages"),where("auction","==",aid),orderBy("time"));
onSnapshot(q,s=>{
chat.innerHTML="<h3>Sohbet</h3>";
s.forEach(m=>chat.innerHTML+=`<div class="card"><b>${m.data().from}</b><br>${m.data().text}</div>`);
chat.innerHTML+=`<textarea id="msg"></textarea><button onclick="sendMsg('${aid}')">GÃ¶nder</button>`;
});
}

window.sendMsg=id=>{
addDoc(collection(db,"messages"),{
auction:id,from:user.email,text:msg.value,time:Date.now()
});
msg.value="";
}
</script>
</body>
</html>
