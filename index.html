<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<title>GÃ¼vercin PazarÄ± TR</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body{margin:0;font-family:Arial;background:#0f172a;color:#fff}
header{background:#020617;padding:15px;display:flex;justify-content:space-between}
h1{margin:0;color:#facc15;font-size:20px}
button{background:#facc15;border:none;padding:8px 12px;font-weight:bold;border-radius:4px;cursor:pointer}
input,select,textarea{width:100%;padding:7px;margin-bottom:6px}
.container{max-width:1100px;margin:auto;padding:15px}
.card{background:#020617;padding:12px;border-radius:8px;margin-bottom:12px}
.hidden{display:none}
img{width:100%;border-radius:6px}
.image-box{position:relative}
.owner{
position:absolute;top:6px;left:6px;
background:rgba(0,0,0,.75);
padding:5px 7px;border-radius:6px;
font-size:12px;color:#facc15;cursor:pointer
}
.owner small{display:block;color:#cbd5f5;font-size:11px}
.danger{background:#dc2626;color:#fff}
.timer{color:#38bdf8;font-weight:bold}
</style>
</head>
<body>

<header>
<h1>ğŸ•Šï¸ GÃ¼vercin PazarÄ± TR</h1>
<div id="nav"></div>
</header>

<div class="container">
<div id="auth"></div>
<div id="home"></div>
<div id="chat" class="hidden"></div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBxNAZRJZiXDirJDAlm5dLtk0Tp3V-Ncck",
  authDomain: "guvercin-pazari-tr.firebaseapp.com",
  projectId: "guvercin-pazari-tr",
  storageBucket: "guvercin-pazari-tr.firebasestorage.app",
  messagingSenderId: "1052845557831",
  appId: "1:1052845557831:web:6c2ee375cd692f8f694962"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth();
const db = getFirestore();

let user=null;
const nav=document.getElementById("nav");
const home=document.getElementById("home");
const authBox=document.getElementById("auth");
const chat=document.getElementById("chat");

onAuthStateChanged(auth,u=>{
  user=u;
  renderNav();
  renderHome();
});

function renderNav(){
  nav.innerHTML = user ?
  `<button onclick="logout()">Ã‡Ä±kÄ±ÅŸ</button>` :
  `<button onclick="showLogin()">GiriÅŸ</button>
   <button onclick="showRegister()">Ãœye Ol</button>`;
}

window.logout=()=>auth.signOut();

window.showLogin=()=>authBox.innerHTML=`
<div class="card">
<h3>GiriÅŸ</h3>
<input id="le" placeholder="Email">
<input id="lp" type="password" placeholder="Åifre">
<button onclick="login()">GiriÅŸ</button>
</div>`;

window.showRegister=()=>authBox.innerHTML=`
<div class="card">
<h3>Ãœye Ol</h3>
<input id="re" placeholder="Email">
<input id="rp" type="password" placeholder="Åifre">
<input id="rt" placeholder="Telefon (05xxxxxxxxx)">
<button onclick="register()">Ãœye Ol</button>
</div>`;

window.login=()=>signInWithEmailAndPassword(auth,le.value,lp.value);
window.register=async()=>{
  const u=await createUserWithEmailAndPassword(auth,re.value,rp.value);
  await addDoc(collection(db,"users"),{
    email:re.value,
    phone:rt.value
  });
};

function renderHome(){
authBox.innerHTML="";
chat.classList.add("hidden");
home.classList.remove("hidden");

home.innerHTML=user?`
<div class="card">
<h3>Ä°lan Ekle</h3>
<input id="name" placeholder="Ä°lan baÅŸlÄ±ÄŸÄ±">
<input id="price" type="number" placeholder="BaÅŸlangÄ±Ã§ â‚º">
<input id="photo" type="file">
<button onclick="addAuction()">BaÅŸlat</button>
</div>`:"";

onSnapshot(collection(db,"auctions"),snap=>{
home.innerHTML+=`<h3>Ä°lanlar</h3>`;
snap.forEach(async d=>{
const a=d.data();
const now=Date.now();
let end=a.end||a.start+86400000;
const remaining=end-now;
const bids=a.bids||[];
const last=bids[bids.length-1];
const ended=remaining<=0;
const ownerPhone=(await getDoc(doc(db,"users",a.owner))).data()?.phone;

home.innerHTML+=`
<div class="card">
<div class="image-box">
<div class="owner">
@${a.owner}
<small>${ownerPhone||""}</small>
</div>
<img src="${a.photo}">
</div>
<b>${a.name}</b>
<p>ğŸ’° ${a.price} â‚º</p>
<p class="timer">${ended?"Ä°hale bitti":"Kalan: "+format(remaining)}</p>
<p>Son teklif: ${last?last.user:"Yok"}</p>
${!ended && user && user.email!==a.owner?`<button onclick='bid("${d.id}",${a.price})'>Teklif Ver</button>`:""}
${user?.email===a.owner?`<button class="danger" onclick="del('${d.id}')">Sil</button>`:""}
${ended && last?.user===user?.email?`<button onclick='openChat("${d.id}")'>ğŸ’¬ SatÄ±cÄ±yla Sohbet</button>`:""}
</div>`;
});
});
}

window.addAuction=()=>{
const r=new FileReader();
r.onload=e=>{
addDoc(collection(db,"auctions"),{
name:name.value,
price:Number(price.value),
photo:e.target.result,
owner:user.email,
start:Date.now(),
end:Date.now()+86400000,
bids:[]
});
};
r.readAsDataURL(photo.files[0]);
};

window.bid=async(id,price)=>{
const v=Number(prompt("Teklif â‚º"));
if(v<=price) return alert("Daha yÃ¼ksek olmalÄ±");
const ref=doc(db,"auctions",id);
const snap=await getDoc(ref);
const a=snap.data();
let end=a.end;
if(end-Date.now()<300000) end+=300000;
await updateDoc(ref,{
price:v,
end:end,
bids:[...(a.bids||[]),{user:user.email,amount:v}]
});
};

window.del=id=>deleteDoc(doc(db,"auctions",id));

window.openChat=id=>{
home.classList.add("hidden");
chat.classList.remove("hidden");
onSnapshot(collection(db,"messages"),snap=>{
chat.innerHTML="<h3>Sohbet</h3>";
snap.forEach(m=>{
if(m.data().auction===id)
chat.innerHTML+=`<div class="card"><b>${m.data().from}</b><br>${m.data().text}</div>`;
});
chat.innerHTML+=`
<textarea id="msg"></textarea>
<button onclick="sendMsg('${id}')">GÃ¶nder</button>`;
});
};

window.sendMsg=id=>{
addDoc(collection(db,"messages"),{
auction:id,from:user.email,text:msg.value,time:Date.now()
});
msg.value="";
};

function format(ms){
const s=Math.floor(ms/1000);
const h=String(Math.floor(s/3600)).padStart(2,"0");
const m=String(Math.floor((s%3600)/60)).padStart(2,"0");
const sec=String(s%60).padStart(2,"0");
return `${h}:${m}:${sec}`;
}
</script>
</body>
</html>
