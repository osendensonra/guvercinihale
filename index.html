<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<title>GÃ¼vercin PazarÄ± TR</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body{margin:0;font-family:Arial;background:#0f172a;color:#fff}
header{background:#020617;padding:15px;display:flex;justify-content:space-between;align-items:center}
header h1{color:#facc15;font-size:20px;margin:0}
nav button{margin-left:6px}
button{background:#facc15;border:none;padding:8px 12px;font-weight:bold;border-radius:4px;cursor:pointer}
input,textarea{width:100%;padding:8px;margin-bottom:6px}
.container{max-width:900px;margin:auto;padding:20px}
.card{background:#020617;padding:15px;border-radius:8px;margin-bottom:12px}
.small{color:#cbd5f5;font-size:14px}
.hidden{display:none}
img{width:100%;border-radius:6px;margin-bottom:8px}
.image-box{position:relative}
.owner-badge{
  position:absolute;top:8px;left:8px;
  background:rgba(0,0,0,0.75);
  color:#facc15;padding:4px 8px;
  border-radius:6px;font-size:13px;
  font-weight:bold;cursor:pointer
}
.danger{background:#dc2626;color:#fff}
</style>
</head>
<body>

<header>
<h1>ğŸ•Šï¸ GÃ¼vercin PazarÄ± TR</h1>
<nav id="nav"></nav>
</header>

<div class="container">
<div id="home"></div>
<div id="profile" class="hidden"></div>
<div id="chat" class="hidden"></div>

<div id="login" class="card hidden">
<h3>GiriÅŸ</h3>
<input id="loginEmail" placeholder="Email">
<input id="loginPass" type="password" placeholder="Åifre">
<button onclick="login()">GiriÅŸ Yap</button>
</div>

<div id="register" class="card hidden">
<h3>Ãœye Ol</h3>
<input id="regEmail" placeholder="Email">
<input id="regPass" type="password" placeholder="Åifre">
<button onclick="register()">Ãœye Ol</button>
</div>
</div>

<!-- ğŸ”¥ FIREBASE -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import {
  getAuth, createUserWithEmailAndPassword,
  signInWithEmailAndPassword, onAuthStateChanged
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import {
  getFirestore, collection, addDoc, getDocs,
  query, where, doc, deleteDoc, updateDoc,
  onSnapshot, orderBy
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

/* ğŸ” CONFIG */
const firebaseConfig = {
  apiKey: "AIzaSyBxNAZRJZiXDirJDAlm5dLtk0Tp3V-Ncck",
  authDomain: "guvercin-pazari-tr.firebaseapp.com",
  projectId: "guvercin-pazari-tr",
  storageBucket: "guvercin-pazari-tr.firebasestorage.app",
  messagingSenderId: "1052845557831",
  appId: "1:1052845557831:web:6c2ee375cd692f8f694962"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth();
const db = getFirestore();

/* ğŸ§  STATE */
let currentUser = null;

/* ğŸ“Œ DOM */
const home = document.getElementById("home");
const profile = document.getElementById("profile");
const chat = document.getElementById("chat");
const nav = document.getElementById("nav");
const loginBox = document.getElementById("login");
const registerBox = document.getElementById("register");

/* ğŸ” NAV */
function renderNav(){
  nav.innerHTML = currentUser ?
  `<button onclick="showHome()">Ana Sayfa</button>
   <button onclick="showProfile('${currentUser.email}')">Profilim</button>
   <button onclick="logout()">Ã‡Ä±kÄ±ÅŸ</button>`
  :
  `<button onclick="toggle('login')">GiriÅŸ</button>
   <button onclick="toggle('register')">Ãœye Ol</button>`;
}
window.toggle = id => {
  loginBox.classList.add("hidden");
  registerBox.classList.add("hidden");
  document.getElementById(id).classList.toggle("hidden");
};

window.logout = () => auth.signOut();

/* ğŸ‘¤ AUTH */
window.register = () =>
createUserWithEmailAndPassword(auth, regEmail.value, regPass.value)
.catch(e=>alert(e.message));

window.login = () =>
signInWithEmailAndPassword(auth, loginEmail.value, loginPass.value)
.catch(e=>alert(e.message));

onAuthStateChanged(auth, user=>{
  currentUser = user;
  renderNav();
  showHome();
});

/* â• AUCTION */
window.addAuction = async () => {
  if(!currentUser) return alert("GiriÅŸ yap");
  const file = photo.files[0];
  const r = new FileReader();
  r.onload = async e => {
    await addDoc(collection(db,"auctions"),{
      name:name.value,
      price:Number(price.value),
      photo:e.target.result,
      owner:currentUser.email,
      start:Date.now(),
      bids:[]
    });
  };
  r.readAsDataURL(file);
};

/* ğŸ’° BID */
window.bid = async (id,price,bids)=>{
  const amt = prompt("Teklif â‚º");
  if(!amt) return;
  await updateDoc(doc(db,"auctions",id),{
    price:Number(amt),
    bids:[...bids,{user:currentUser.email,amount:Number(amt)}]
  });
};

/* ğŸ—‘ï¸ DELETE */
window.del = id => deleteDoc(doc(db,"auctions",id));

/* ğŸ’¬ CHAT */
window.openChat = async (auction)=>{
  home.classList.add("hidden");
  chat.classList.remove("hidden");

  const q = query(
    collection(db,"messages"),
    where("auction","==",auction.id),
    orderBy("time")
  );

  onSnapshot(q,snap=>{
    chat.innerHTML = `<h3>ğŸ’¬ MesajlaÅŸma</h3>`;
    snap.forEach(d=>{
      chat.innerHTML += `<div class="card">
        <b>${d.data().from}</b><br>${d.data().text}
      </div>`;
    });
    chat.innerHTML += `
    <textarea id="msg"></textarea>
    <button onclick="sendMsg('${auction.id}')">GÃ¶nder</button>`;
  });
};

window.sendMsg = async id=>{
  await addDoc(collection(db,"messages"),{
    auction:id,
    from:currentUser.email,
    text:msg.value,
    time:Date.now()
  });
  msg.value="";
};

/* ğŸ  HOME */
function showHome(){
  profile.classList.add("hidden");
  chat.classList.add("hidden");
  home.classList.remove("hidden");

  home.innerHTML = currentUser ? `
  <div class="card">
    <input id="name" placeholder="GÃ¼vercin adÄ±">
    <input id="price" type="number" placeholder="BaÅŸlangÄ±Ã§ â‚º">
    <input id="photo" type="file">
    <button onclick="addAuction()">Ä°haleyi BaÅŸlat</button>
  </div>` : "";

  onSnapshot(collection(db,"auctions"), snap=>{
    home.innerHTML += "<h3>Ä°lanlar</h3>";
    snap.forEach(d=>{
      const a = d.data();
      const last = a.bids[a.bids.length-1];
      const ended = Date.now()>a.start+86400000;
      const win = ended && last && last.user===currentUser?.email;

      home.innerHTML += `
      <div class="card">
        <div class="image-box">
          <span class="owner-badge" onclick="showProfile('${a.owner}')">@${a.owner}</span>
          <img src="${a.photo}">
        </div>
        <b>${a.name}</b>
        <p>ğŸ’° ${a.price} â‚º</p>
        <p class="small">ğŸ‘¤ Son teklif: ${last?last.user:"Yok"}</p>
        ${!ended && currentUser ? `<button onclick="bid('${d.id}',${a.price},${JSON.stringify(a.bids)})">Teklif Ver</button>`:""}
        ${currentUser?.email===a.owner ? `<button class="danger" onclick="del('${d.id}')">Sil</button>`:""}
        ${win ? `<button onclick='openChat({id:"${d.id}"})'>ğŸ’¬ MesajlaÅŸ</button>`:""}
      </div>`;
    });
  });
}

/* ğŸ‘¤ PROFILE */
window.showProfile = email=>{
  home.classList.add("hidden");
  profile.classList.remove("hidden");
  profile.innerHTML = `<h2>${email}</h2>`;
};
</script>

</body>
</html>
